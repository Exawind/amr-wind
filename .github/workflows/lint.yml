name: AMR-Wind Lint

on:
  push:
    branches: [development]
    paths:
      - 'cmake/**'
      - 'amr-wind/**'
      - 'submods/**'
      - 'test/**'
      - 'unit_tests/**'
      - 'CMakeLists.txt'
      - '.github/workflows/lint.yml'
  pull_request:
    branches: [development]
    paths:
      - 'cmake/**'
      - 'amr-wind/**'
      - 'submods/**'
      - 'test/**'
      - 'unit_tests/**'
      - 'CMakeLists.txt'
      - '.github/workflows/lint.yml'

jobs:
  cppcheck:
    runs-on: macos-latest
    steps:
      - name: Cancel previous runs
        uses: styfle/cancel-workflow-action@0.6.0
        with:
          access_token: ${{github.token}}
      - uses: actions/checkout@v2
        with:
          submodules: true
      - name: Dependencies
        run: brew install cppcheck
      - name: Configure
        run: |
          echo "NPROCS=$(sysctl -n hw.ncpu)" >> $GITHUB_ENV
          cmake \
          -Bbuild-cppcheck \
          -DAMR_WIND_ENABLE_MPI:BOOL=OFF \
          -DAMR_WIND_ENABLE_TESTS:BOOL=ON \
          -DAMR_WIND_TEST_WITH_FCOMPARE:BOOL=OFF \
          -DAMR_WIND_ENABLE_MASA:BOOL=OFF \
          -DCMAKE_EXPORT_COMPILE_COMMANDS:BOOL=ON \
          ${{github.workspace}}
      - name: Check
        working-directory: build-cppcheck
        run: |
          # Using a working directory for cppcheck makes analysis faster
          mkdir cppcheck-wd
          # Cppcheck ignores -isystem directories, so we change them to regular -I include directories (with no spaces either)
          sed -i '' -e 's/isystem /I/g' compile_commands.json
          cppcheck --inline-suppr \
            --suppress=unmatchedSuppression --suppress=syntaxError --suppress=internalAstError \
            --suppress=unusedFunction --std=c++14 --language=c++ --enable=all --project=compile_commands.json \
            -j ${{env.NPROCS}} --cppcheck-build-dir=cppcheck-wd -i ${{github.workspace}}/submods/amrex/Src \
            -i ${{github.workspace}}/submods/googletest --output-file=cppcheck.txt
          # Warnings in header files are unavoidable, so we filter out submodule headers after analysis
          # Might be wrong to assume cppcheck always reports issues using 3 lines
           awk -v nlines=2 '/submods\/amrex/ || /submods\/googletest/ {for (i=0; i<nlines; i++) {getline}; next} 1' \
            < cppcheck.txt > cppcheck-warnings.txt
      - name: Report
        working-directory: build-cppcheck
        run: |
          echo "::add-matcher::.github/problem-matchers/gcc.json"
          # Might be wrong to assume cppcheck always reports issues using 3 lines
          WARNINGS_TMP=$(wc -l < cppcheck-warnings.txt | xargs echo -n)
          WARNINGS=$(bc <<< "$WARNINGS_TMP/3")
          printf "%s warnings\n" "${WARNINGS}" >> cppcheck-warnings.txt
          cat cppcheck-warnings.txt
  clang-tidy:
    runs-on: ubuntu-latest
    steps:
      - name: Cancel previous runs
        uses: styfle/cancel-workflow-action@0.6.0
        with:
          access_token: ${{github.token}}
      - uses: actions/checkout@v2
        with:
          submodules: true
      - name: Dependencies
        run: |
          sudo apt-get install -y clang-tidy-9
          sudo update-alternatives --install /usr/bin/clang-tidy clang-tidy /usr/bin/clang-tidy-9 100
      - name: Configure
        run: |
          echo "NPROCS=$(nproc)" >> $GITHUB_ENV
          cmake \
          -Bbuild-clang-tidy \
          -DCMAKE_CXX_COMPILER:STRING=clang++ \
          -DCMAKE_C_COMPILER:STRING=clang \
          -DAMR_WIND_ENABLE_MPI:BOOL=OFF \
          -DAMR_WIND_ENABLE_TESTS:BOOL=ON \
          -DAMR_WIND_TEST_WITH_FCOMPARE:BOOL=OFF \
          -DAMR_WIND_ENABLE_MASA:BOOL=OFF \
          -DAMR_WIND_ENABLE_ALL_WARNINGS:BOOL=OFF \
          -DAMR_WIND_ENABLE_CLANG_TIDY:BOOL=ON \
          -DCMAKE_EXPORT_COMPILE_COMMANDS:BOOL=ON \
          ${{github.workspace}}
      - name: Check
        working-directory: build-clang-tidy
        run: cmake --build . -- -j ${{env.NPROCS}} 2> clang-tidy-warnings.txt
      - name: Report
        working-directory: build-clang-tidy
        run: |
          echo "::add-matcher::.github/problem-matchers/gcc.json"
          cat clang-tidy-warnings.txt
